<html ng-app="app">
<head>
	<title>jsPratiche!</title>
</head>
<body>

<ng-view></ng-view>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-route.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-resource.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

<script type="text/ng-template" id="/gestori.html">
	Search: <input type="text" ng-model="search.name">
	<ul>
		<li ng-repeat="gestore in gestori | filter: search">			
			<a ng-show="!editing[$index]" href="#/{{gestore.id}}">{{gestore.name}}</a>
			<button ng-show="!editing[$index]" ng-click="edit($index)">edit</button>
			<button ng-show="!editing[$index]" ng-click="remove($index)">remove</button>

			<input ng-show="editing[$index]" type="text" ng-model="gestore.name">
			<input ng-show="editing[$index]" type="text" ng-model="gestore.pec">
			<button ng-show="editing[$index]" ng-click="update($index)">Update</button>
			<button ng-show="editing[$index]" ng-click="cancel($index)">Cancel</button>
		</li>
	</ul>
	Nuovo Gestore: <input type="text" ng-model="newGestore"><input type="text" ng-model="newPec"><button ng-click="save()">Create</button>
</script>


<script type="text/ng-template" id="/gestoreDetails.html">
	<div>id: {{ egestore.id }}</div>
	<div>name: <textarea ng-model="egestore.name"></textarea></div>
	<div>pec: <textarea ng-model="egestore.pec"></textarea></div>
	<button ng-click="update()">Update</button>
	<button ng-click="remove()">Remove</button>
	<button ng-click="cancel()">Cancel</button>
</script>


<script>
angular.module('app', ['ngRoute', 'ngResource'])
	.factory('Gestori', ['$resource', function($resource){
		return $resource('/gestori/:id', null, {
			'update': { method:'PUT' }
		});
	}])

	.controller('GestoriController', ['$scope', 'Gestori', function($scope, Gestori) {
		$scope.editing = [];
		$scope.gestori = Gestori.query();
		$scope.save = function() {
			if (!$scope.newGestore || $scope.newGestore.length < 1) return;
			var gestore = new Gestori({ name: $scope.newGestore, pec: $scope.newPec });

			gestore.$save(function(){
				$scope.gestori.push(gestore);
				$scope.newGestore = '';
				$scope.newPec = '';
			});
		}
		$scope.update = function(index){
			var gestore = $scope.gestori[index];
			console.log("updating with: {"+ gestore.name+" "+gestore.id+"}");
			Gestori.update({id: gestore.id}, gestore);
			$scope.editing[index] = false;
		}

		$scope.edit = function(index){
			$scope.editing[index] = angular.copy($scope.gestori[index]);
		}

		$scope.cancel = function(index){
			$scope.gestori[index] = angular.copy($scope.editing[index]);
			$scope.editing[index] = false;
		}
		$scope.remove = function(index){
			var gestore = $scope.gestori[index];
			Gestori.remove({id: gestore.id}, function(){
				$scope.gestori.splice(index, 1);
			});
		}
	}])
  
	.controller('GestoreDetailCtrl', ['$scope', '$routeParams', 'Gestori', '$location', function($scope, $routeParams, Gestori, $location) {
		$scope.egestore = Gestori.get({id: $routeParams.id });
		
		$scope.update = function( ){
			Gestori.update({id: $scope.egestore.id}, $scope.egestore, function() {
				$location.url('/');
			});
		}
		
		$scope.remove = function() {
			Gestori.remove({id: $scope.egestore.id}, function() {
				$location.url('/');
			});			
		}
		
		$scope.cancel = function() {
			$location.url('/');
		}
	}])
	
	.config(['$routeProvider', function($routeProvider) {
		$routeProvider
			.when('/', {
				templateUrl: '/gestori.html',
				controller: 'GestoriController'
			})
			.when('/:id', {
				templateUrl: '/gestoreDetails.html',
				controller: 'GestoreDetailCtrl'
			});
	}]);
</script>

</body>
</html>